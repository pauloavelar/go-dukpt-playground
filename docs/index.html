<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DUKPT Workflow Documentation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Set theme based on system preference
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            document.documentElement.setAttribute('data-bs-theme', prefersDark ? 'dark' : 'light');
            
            // Check if Mermaid is loaded
            if (typeof mermaid !== 'undefined') {
                const mermaidTheme = prefersDark ? 'dark' : 'neutral';
                mermaid.initialize({ startOnLoad: true, theme: mermaidTheme });
            } else {
                console.warn('Mermaid.js failed to load from CDN. Diagrams will show as text.');
                // Add a notice to the page
                const notice = document.createElement('div');
                notice.className = 'alert alert-warning mx-3 mt-3';
                notice.innerHTML = '<strong>Note:</strong> This page uses Mermaid.js from an external CDN for diagram rendering. If diagrams appear as text, please ensure external resources can be loaded.';
                document.body.insertBefore(notice, document.body.firstChild);
            }
            
            // Listen for system theme changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                document.documentElement.setAttribute('data-bs-theme', e.matches ? 'dark' : 'light');
                // Note: Mermaid diagrams will require page refresh for theme change
            });
        });
    </script>
</head>
<body>
    <nav class="navbar navbar-expand-lg bg-primary sticky-top" data-bs-theme="dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">DUKPT Playground</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="key-theory.html">Key Theory</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#overview">Overview</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            Implementation
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#workflow">Workflow</a></li>
                            <li><a class="dropdown-item" href="#ipek">IPEK Derivation</a></li>
                            <li><a class="dropdown-item" href="#session-keys">Session Keys</a></li>
                            <li><a class="dropdown-item" href="#encryption">Data Encryption</a></li>
                            <li><a class="dropdown-item" href="#examples">Examples</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <section id="overview" class="mb-5">
            <div class="row">
                <div class="col-12">
                    <h2 class="border-bottom border-primary pb-2 mb-4">DUKPT Overview</h2>
                    <p class="lead">
                        <strong>DUKPT (Derived Unique Key Per Transaction)</strong> is a key management scheme 
                        used in secure payment processing systems. It ensures that each transaction uses a 
                        unique encryption key, preventing replay attacks and enhancing security.
                    </p>
            
            <h3 class="mt-4">Key Components</h3>
            <ul class="list-group list-group-flush">
                <li class="list-group-item"><strong>BDK (Base Derivation Key)</strong>: A 16-byte master key</li>
                <li class="list-group-item"><strong>KSN (Key Serial Number)</strong>: A 10-byte identifier containing device ID and transaction counter</li>
                <li class="list-group-item"><strong>IPEK (Initial PIN Encryption Key)</strong>: Derived from BDK and KSN</li>
                <li class="list-group-item"><strong>Session Key</strong>: Unique key derived for each transaction</li>
            </ul>

            <h3 class="mt-4">Security Benefits</h3>
            <ul class="list-group list-group-flush">
                <li class="list-group-item">Each transaction uses a unique encryption key</li>
                <li class="list-group-item">Keys cannot be reverse-engineered from encrypted data</li>
                <li class="list-group-item">Non-reversible key generation process (NRKGP)</li>
                <li class="list-group-item">Limited key exposure in case of compromise</li>
            </ul>
                </div>
            </div>
        </section>

        <section id="workflow" class="mb-5">
            <div class="row">
                <div class="col-12">
                    <h2 class="border-bottom border-primary pb-2 mb-4">Complete DUKPT Workflow</h2>
                    <p>The following diagram shows the complete DUKPT transaction workflow:</p>
                    
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="mermaid">
sequenceDiagram
    participant T as Terminal
    participant C as Card
    participant H as Key Management (HSM)
    
    T->>C: Request Track Data
    C->>T: Track2 Data (PAN, Exp, etc.)
    
    Note over T: Terminal derives encryption keys locally:<br/>1. Derive IPEK from BDK + KSN<br/>2. Extract transaction counter from KSN<br/>3. Derive Session Key using NRKGP<br/>4. Apply data variant mask<br/>5. Encrypt Track2 with 3DES
    
    T->>H: Send Encrypted Data + KSN
    
    Note over H: HSM recreates same keys:<br/>1. Derive IPEK from BDK + KSN<br/>2. Derive same Session Key<br/>3. Decrypt Track2 data
    
    H->>T: Transaction Authorization
                            </div>
                        </div>
                        <div class="card-footer">
                            <h6 class="card-title mb-3">Key Security Properties:</h6>
                            <ul class="mb-0">
                                <li>Each transaction uses a unique session key</li>
                                <li>Keys cannot be reverse-engineered from encrypted data</li>
                                <li>Non-reversible key generation process (NRKGP)</li>
                                <li>Limited key exposure if device is compromised</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="ipek" class="mb-5">
            <div class="row">
                <div class="col-12">
                    <h2 class="border-bottom border-primary pb-2 mb-4">IPEK Derivation Process</h2>
                    <p>
                        The Initial PIN Encryption Key (IPEK) is derived from the Base Derivation Key (BDK) 
                        and the Key Serial Number (KSN). This is the first step in the DUKPT process.
                    </p>

                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="mermaid">
flowchart TD
    BDK[BDK<br/>Base Derivation Key<br/>16 bytes]
    KSN[KSN<br/>Key Serial Number<br/>10 bytes]
    
    BDK --> MaskBDK[Mask BDK with<br/>0xC0C0C0C0...C0]
    KSN --> MaskKSN[Mask KSN for IPEK<br/>first 8 bytes,<br/>clear last 5 bits]
    
    MaskBDK --> MBDK[Masked BDK]
    MaskKSN --> MKSN[Masked KSN]
    
    BDK --> LeftEnc[3DES Encrypt<br/>Masked KSN with<br/>original BDK]
    MBDK --> RightEnc[3DES Encrypt<br/>Masked KSN with<br/>masked BDK]
    MKSN --> LeftEnc
    MKSN --> RightEnc
    
    LeftEnc --> IPEKLeft[IPEK Left Half]
    RightEnc --> IPEKRight[IPEK Right Half]
    
    IPEKLeft --> IPEK[IPEK<br/>Initial PIN Encryption Key<br/>Left || Right<br/>16 bytes]
    IPEKRight --> IPEK
                            </div>
                        </div>
                        <div class="card-footer">
                            <h6 class="card-title">Mathematical Representation:</h6>
                            <code class="d-block">IPEK_Left = 3DES_Encrypt(Masked_KSN, BDK)</code>
                            <code class="d-block">IPEK_Right = 3DES_Encrypt(Masked_KSN, Masked_BDK)</code>
                            <code class="d-block">IPEK = IPEK_Left || IPEK_Right</code>
                        </div>
                    </div>

                    <h3 class="mt-4">Implementation Details</h3>
                    <p>The IPEK derivation follows these specific steps:</p>
                    <ol class="list-group list-group-numbered">
                        <li class="list-group-item"><strong>KSN Masking</strong>: Extract the first 8 bytes and clear the last 5 bits of the 8th byte</li>
                        <li class="list-group-item"><strong>BDK Masking</strong>: XOR the BDK with the fixed mask defined in ANSI X9.24-1:2017</li>
                        <li class="list-group-item"><strong>Left Half</strong>: 3DES encrypt the masked KSN using the original BDK</li>
                        <li class="list-group-item"><strong>Right Half</strong>: 3DES encrypt the masked KSN using the masked BDK</li>
                        <li class="list-group-item"><strong>Combine</strong>: Concatenate left and right halves to form the 16-byte IPEK</li>
                    </ol>
                </div>
            </div>
        </section>

        <section id="session-keys" class="mb-5">
            <div class="row">
                <div class="col-12">
                    <h2 class="border-bottom border-primary pb-2 mb-4">Session Key Derivation</h2>
                    <p>
                        Session keys are derived from the IPEK using the Non-Reversible Key Generation Process (NRKGP).
                        Each transaction uses a unique session key based on the transaction counter in the KSN.
                    </p>

                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="mermaid">
flowchart TD
    IPEK[IPEK<br/>from previous step<br/>16 bytes]
    KSN[KSN<br/>Key Serial Number<br/>10 bytes]
    
    IPEK --> StartKey[Session Key = IPEK<br/>initially]
    KSN --> ExtractKSN[Extract from KSN:<br/>• KSI Key Set ID<br/>• Counter 21 bits]
    
    ExtractKSN --> CheckBits[For each bit set in counter]
    
    CheckBits --> BitSet{Bit Set?}
    BitSet -->|Yes| BuildKSN[Build KSN register<br/>with single bit set]
    BitSet -->|No| NextBit[Check next bit]
    
    BuildKSN --> NRKGP[Apply NRKGP:<br/>1. Mask key with 0xC0<br/>2. Split into L/R halves<br/>3. DES encrypt each half<br/>4. Combine encrypted halves]
    
    NRKGP --> UpdateKey[Update session key]
    UpdateKey --> NextBit
    
    NextBit --> MoreBits{More bits?}
    MoreBits -->|Yes| CheckBits
    MoreBits -->|No| ApplyMask[Apply Data Mask<br/>0x0000000000FF00000...FF0000]
    
    ApplyMask --> FinalKey[Final Session Key<br/>Ready for encryption<br/>16 bytes]
                            </div>
                        </div>
                        <div class="card-footer">
                            <h6 class="card-title">NRKGP Algorithm Details:</h6>
                            <pre class="mb-0"><code>For bit_position in transaction_counter:
  if bit is set:
    ksn_reg = build_ksn_register(ksi, bit_position)
    session_key = nrkgp(session_key, ksn_reg)

session_key = apply_data_mask(session_key)</code></pre>
                        </div>
                    </div>

                    <h3 class="mt-4">NRKGP Process</h3>
                    <p>The Non-Reversible Key Generation Process ensures forward security:</p>
                    <ol class="list-group list-group-numbered">
                        <li class="list-group-item">Mask the current key with 0xC0 (XOR)</li>
                        <li class="list-group-item">Split the masked key into left and right halves</li>
                        <li class="list-group-item">DES encrypt each half with the KSN register data</li>
                        <li class="list-group-item">Combine the encrypted halves to form the new key</li>
                        <li class="list-group-item">Repeat for each bit set in the transaction counter</li>
                    </ol>
                </div>
            </div>
        </section>

        <section id="encryption" class="mb-5">
            <div class="row">
                <div class="col-12">
                    <h2 class="border-bottom border-primary pb-2 mb-4">Data Encryption Process</h2>
                    <p>
                        The final step encrypts the actual track data using the derived session key.
                        Track2 data contains payment card information in a standardized format.
                    </p>

                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="mermaid">
flowchart TD
    Track2[Track2 Data<br/>PAN, Expiry,<br/>Service Code]
    SessionKey[Session Key with<br/>Data Variant<br/>Mask Applied]
    
    Track2 --> Format[Format Track2<br/>Add sentinels and<br/>separators<br/>PAN with exp date]
    
    Format --> BCD[Convert to BCD<br/>Binary Coded Decimal]
    
    BCD --> Pad[Pad to 8-byte blocks<br/>DES requirement<br/>Right-pad with 0x00]
    
    SessionKey --> Normalize[Normalize to<br/>24-byte key<br/>K1, K2, K1<br/>for 3DES]
    
    Pad --> Encrypt[3DES Encryption<br/>CBC Mode<br/><br/>For each 8-byte block:<br/>Apply 3DES encryption<br/>using derived session key]
    Normalize --> Encrypt
    
    Encrypt --> Result[Encrypted Track2 Data<br/>Ready for transmission]
                            </div>
                        </div>
                        <div class="card-footer">
                            <h6 class="card-title">Track2 Format Example:</h6>
                            <small class="text-muted d-block">Input: PAN=1234123412341234, Exp=12/25, SC=601, DD=123123</small>
                            <code class="d-block">Format: ;1234123412341234=251206011231233?</code>
                            <code class="d-block">BCD: 3B12341234123412343D251206011231233F</code>
                            <code class="d-block">Padded: 3B12341234123412343D251206011231233F0000</code>
                            <code class="d-block">Final: B04B8CB78C7F5186981EF46D2D79B83F0000</code>
                        </div>
                    </div>

                    <h3 class="mt-4">Track2 Format</h3>
                    <p>Track2 data follows ISO/IEC 7813 format:</p>
                    <div class="bg-light p-3 rounded mb-3">
                        <code>;PAN=YYMM[ServiceCode][DiscretionaryData]?</code>
                    </div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><strong>;</strong> - Start sentinel</li>
                        <li class="list-group-item"><strong>PAN</strong> - Primary Account Number (card number)</li>
                        <li class="list-group-item"><strong>=</strong> - Field separator</li>
                        <li class="list-group-item"><strong>YYMM</strong> - Expiration date (year/month)</li>
                        <li class="list-group-item"><strong>ServiceCode</strong> - 3-digit service code (optional)</li>
                        <li class="list-group-item"><strong>DiscretionaryData</strong> - Additional data (optional)</li>
                        <li class="list-group-item"><strong>?</strong> - End sentinel</li>
                    </ul>
                </div>
            </div>
        </section>

        <section id="examples" class="mb-5">
            <div class="row">
                <div class="col-12">
                    <h2 class="border-bottom border-primary pb-2 mb-4">Practical Examples</h2>
                    <p>Here are real examples from the Go implementation:</p>

                    <h3 class="mt-4">Example Transaction</h3>
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Input Parameters:</h5>
                        </div>
                        <div class="card-body">
                            <pre class="mb-0"><code>BDK: 0123456789ABCDEFFEDCBA9876543210
KSN: 12345678901234567890

Track2 Data:
  PAN: 1234123412341234
  Expiry: 12/2025
  Service Code: 601
  Discretionary Data: 123123</code></pre>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Process:</h5>
                        </div>
                        <div class="card-body">
                            <pre class="mb-0"><code>1. Formatted Track2: 3B12341234123412343D251206011231233F
2. IPEK Derivation: [derived from BDK + masked KSN]
3. Session Key: [derived using NRKGP process]
4. Encrypted Result: B04B8CB78C7F5186981EF46D2D79B83F0000</code></pre>
                        </div>
                    </div>

                    <h3 class="mt-4">Code Usage</h3>
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Go Implementation Example</h5>
                        </div>
                        <div class="card-body">
                            <pre class="mb-0"><code>// Go implementation example
package main

import (
    "encoding/hex"
    "github.com/pauloavelar/go-dukpt-playground/dukpt"
    "github.com/pauloavelar/go-dukpt-playground/track2"
)

func main() {
    // Define test keys
    bdk := mustDecodeHex("0123456789ABCDEFFEDCBA9876543210")
    ksn := mustDecodeHex("12345678901234567890")
    
    // Create track2 data
    t2 := track2.Data{
        PAN:               "1234123412341234",
        ExpYear:           2025,
        ExpMonth:          12,
        ServiceCode:       "601",
        DiscretionaryData: "123123",
    }
    
    // Format and encrypt
    formatted, err := t2.FormatISO()
    if err != nil {
        panic(err)
    }
    
    encrypted, err := dukpt.EncryptTrack2(formatted, bdk, ksn)
    if err != nil {
        panic(err)
    }
    
    fmt.Printf("Encrypted: %s\n", hex.EncodeToString(encrypted))
}</code></pre>
                        </div>
                    </div>

                    <h3 class="mt-4">Key Derivation Examples</h3>
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">IPEK Derivation Steps:</h5>
                        </div>
                        <div class="card-body">
                            <pre class="mb-0"><code>Original KSN: 12345678901234567890
Masked KSN:   123456789012345678E0  (last 5 bits cleared)
BDK Mask:     C0C0C0C000000000C0C0C0C000000000
Masked BDK:   C1E396C589ABCDEFFE1C7AC876543210

Left Half:  3DES_Encrypt(Masked_KSN, Original_BDK)
Right Half: 3DES_Encrypt(Masked_KSN, Masked_BDK)
IPEK:       Left_Half || Right_Half</code></pre>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <footer class="bg-body-tertiary text-center py-4 mt-5">
        <div class="container">
            <p class="mb-2">&copy; 2025 Paulo Avelar. Educational implementation of DUKPT key management.</p>
            <p class="mb-0">
                <a href="https://github.com/pauloavelar/go-dukpt-playground" class="link-primary">View on GitHub</a> |
                <a href="https://github.com/pauloavelar/go-dukpt-playground/blob/main/LICENSE" class="link-primary">License</a>
            </p>
        </div>
    </footer>

    <script>
        // Smooth scrolling for navigation links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });
    </script>
</body>
</html>